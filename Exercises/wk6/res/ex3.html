<!DOCTYPE html>
<html>

<head>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        /* Set the size of the div element that contains the map */
        #map {
            height: 400px;
            /* The height is 400 pixels */
            width: 100%;
            /* The width is the width of the web page */
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

</head>

<body>
    <h3>My Google Map</h3>
    <!--The div element for the map -->
    <div id="map"></div>

    <div class="jumbotron">
        <p class="lead text-center">Get Geo Location</p>
        <form>
            <div class="form-group">
                <label for="addr">Enter An Address</label>
                <input type="text" class="form-control" name="addr" id="addr"
                    placeholder="E.g. Singapore Management University">
                <br><button type="button" onclick="getLoc('addr')" class="btn btn-primary">Get Full Address!</button>
                <button type="button" onclick="getLoc('postcode')" class="btn btn-primary">Get Postal Code!</button>
                <!-- the following set the lat, lng values to put a marker on the map-->
                <input type="hidden" id="lat" name="lat" value="1.2973784" />
                <input type="hidden" id="lng" name="lng" value="103.8495219" />
            </div>
            <p id="display" class="lead text-center"></p>
        </form>
    </div>

    <script>
        //todo: Initialize and add the map

        //default smu
        var lat = "1.2973784"
        var lng = "103.8495219"
        var title = "Hello SMU"

        var map
        function initMap() {

            lat = parseFloat(lat)
            lng = parseFloat(lng)

            //key lat mapped to var lat, key lng mapped to var lng
            var loc = {lat: lat, lng: lng}

            map = new google.maps.Map(
                document.getElementById('map'), {
                    center: loc,
                    zoom: 14
            });

            const marker = new google.maps.Marker({position: loc, map: map, title: title})           
        }

        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
            infoWindow.setPosition(pos);
            infoWindow.setContent(browserHasGeolocation ?
                                'Error: The Geolocation service failed.' :
                                'Error: Your browser doesn\'t support geolocation.');
            infoWindow.open(map);
        }

        //todo: Load the map using Google Maps API

        

        function getLoc(action) {
            //todo: Read the user input; make an Async request to load the address/postcode; and re-center the map
            //Hint: you can use function encodeURI to generate an encoded address string from the user input. 
            var userAddr = document.getElementById("addr").value //can be either add or postcode depending on button pressed
            var url = "https://maps.googleapis.com/maps/api/geocode/json"
            var apiKey = "AIzaSyC3EOF-YSfUFeZd6XGucXH6KLPTMVD-QDg"

            axios.get(url,{
                params: {
                    address : userAddr,
                    key : apiKey
                }
            })

            .then(response => {
                let data = response.data
                console.log(data)

                let info = ''
                if (action == "postcode") {
                    info = getPostCode(data)
                } 
                else {
                    info = getFullAddress(data) //user press addr
                }

                console.log(info)

                document.getElementById("display").innerText = info
                //refresh hidden input w new lat lng

                let coordinate = getLatLng(data)
                lat = coordinate["lat"]
                lng = coordinate["lng"]
                title = "Hello " + addr

                initMap() //refresh the map

            })

            .catch (error => {
                document.getElementById("display").innerText = "Sorry, invalid address. Please try again!"
            })
            
        }

        function getFullAddress(data) {
            var addr = data["results"][0]["formatted_address"]
            var loc = getLatLng(data) //to get full addr lat lng
            return addr + ", lat: " + loc["lat"] + ", lng: " + loc["lng"]
        }

        function getLatLng(data) {
            var location = data["results"][0]["geometry"]["location"]
            return location 
            //data["results"][0]["geometry"]["location"]["lat"] or data["results"][0]["geometry"]["location"]["lng"]
        }

        function getPostCode(data) {
            var addrcomponents = data["results"][0]["address_components"]
            var postcode = addrcomponents.filter(postcodeHelper)
            //.filter(test) creates a shallow copy of a portion of a given array, filtered down to just the elements from the given array that pass the test implemented by the provided function
            //basically looking for data with key postal_code
            return postcode[0]["long_name"]
        }

        function postcodeHelper(addr) {
            return addr["types"][0] == "postal_code"
        }


        //ans key got these funcs but idk for what :/

        function getKeys(data){
            // data["results"][0] is an object
            // this gets the keys/properties of results[0] object
            var keys = Object.keys(data["results"][0]);
            for (key of keys) {
                // this prints --
                /*  address_components
                    formatted_address
                    geometry
                    place_id
                    plus_code
                    types */
                document.getElementById("display").innerText += key + "; ";
            }
        }

        function getCountry(data) {
            // this is an array
            var addrcomponents = data["results"][0]["address_components"];
            // The filter() method creates a new array with array elements that passes a test.
            var country = addrcomponents.filter(countryHelper);
            // country is an array but there should be only one element
            return country[0]["long_name"];
        }

        function countryHelper(addr, index) {  
            return addr["types"][0] == "country" ;
        }



    </script>

    <!-- load the map asynchronously, i.e., load data soon as it becomes available -->
    <script 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3EOF-YSfUFeZd6XGucXH6KLPTMVD-QDg&callback=initMap"
        async defer>
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
</body>

</html>